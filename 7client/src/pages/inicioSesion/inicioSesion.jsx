import React,{useState} from "react";
import styles from "./inicioSesion.module.css";
import Navbar from "../../components/navbar/navbar";
import Footer from "../../components/footer/footer";
import iniImg from "../../assets/titSes.png"
import Input from "../../components/inputs/input";
import botonLog from "../../assets/boton.png"
import productosImg from "../../assets/productos.png";
import { Link, useNavigate } from "react-router-dom";
import Swal from "sweetalert2";


//importamos iconos
import iconoSes from "../../assets/ico_nombre.png";
import inconoPass from "../../assets/ico_contra.png";
import inconoPassDer from "../../assets/ico_ojo.png";

//importamos las imagenes de corazones
import ballonder2 from "../../assets/balloon_der2.png";
import ballonder from "../../assets/balloon_der.png";
import ballon1zq from "../../assets/balloon_izq.png";



const InicioSesion = () => {

    const navigate = useNavigate();
    const [Loading, setLoading] = useState(false);
    const [errorMensaje, setErrorMensaje] = useState("");

    const [formData, setFormData] = useState({
        Correo: "",
        Contrase√±a: ""
    });

    const handleCorreo = (e) => {
        const { name, value } = e.target;
      
        setFormData((prevData) => ({
          ...prevData,
          "Correo": value
        }));

      };

    const handleContrase√±a = (e) => {
        const { name, value } = e.target;
      
        setFormData((prevData) => ({
          ...prevData,
          "Contrase√±a": value
        }));


      };


    ///funcion para enviar la info al servidor
    const handleSubmit = async (e) => {
                e.preventDefault();
                if(Loading)return
                setLoading(true)
        
                let json = {
                    pass: formData.Contrase√±a,
                    email: formData.Correo,
                  }
              
                try {
                  const response = await fetch("https://7up-production.up.railway.app/user/getUserByEmail", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(json),
                  });
              
                  if (!response.ok) {
                    throw new Error("Error al enviar los datos");
                  }
              
                  const data = await response.json();

                  setLoading(false)
                  console.log("data GET INFO USER",data);
                  localStorage.setItem("userData", JSON.stringify(data.data));

                  navigate("/miPerfil")
            
              
                } catch (error) {
                  console.error("Error en el registro:", error);
                  setLoading(false)
                  Swal.fire(
                    "¬°UPPPSS!",
                    "El Email o Contrase√±a que enviaste no est√° registrado o lo escribiste mal. <br> Por favor, intenta con otro n√∫mero",
                    "error"
                  );
                }
                
    };
  
          
    ///Funcion para aplicar las validaciones
    const isFormValid = () => {    
        const {
            Correo,
            Contrase√±a
        } = formData;
      
        // Validar campos obligatorios y checkboxes obligatorios
        const camposCompletos = Correo  && Contrase√±a 
      
      
        return camposCompletos 
    };

    ///Funcion para aplicar las validaciones
    const postResetPas = async() => {    

          try {
            let json = {
              email: formData.Correo,
            }
    
            const response = await fetch(" ", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(json),
            });
        
            if (!response.ok) {
              throw new Error("Error al enviar los datos");
            }
        
          } catch (error) {
            console.error("Error en el registro:", error);
            setLoading(false)
            Swal.fire(
              "¬°UPPPSS! üòì",
              "Algo sali√≥ mal al intentar recuperar tu contrase√±a. Por favor, intent√° nuevamente m√°s tarde.",
              "error"
            );
          }
    
    
        };

        ///Funcion para aplicar las validaciones
    const recuperarPass = () => {    
        
      Swal.fire({
        title: '¬øOlvidaste tu contrase√±a?',
        html: '¬øQuer√©s que te enviemos un email para recuperarla?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S√≠, enviarlo',
        cancelButtonText: 'No, cancelar',
      }).then((result) => {
        if (result.isConfirmed) {
          // Aqu√≠ podr√≠as llamar a tu funci√≥n para generar el token y enviar el correo
          Swal.fire({
            title: '¬°Listo!',
            text: 'Te enviamos un mensaje a tu correo con instrucciones para recuperar tu contrase√±a.',
            icon: 'success'
          });

          postResetPas()
        } else {
          Swal.fire({
            title: 'Cancelado',
            text: 'No se envi√≥ ning√∫n correo.',
            icon: 'info'
          });
        }
      });


      };



    return( 
        <div className={styles.Fondo}>
            <Navbar></Navbar>
               
            <div className={styles.container}>
                <h1 className={styles.title}>
                    <img src={iniImg} alt="iniImg" className={styles.titleImg} />
                </h1>

                <form className={styles.loginForm}>
                    <div className={styles.formGroup}>
                        <Input
                          placeholder="Correo electr√≥nico"
                          type="email"
                          iconoIzq={iconoSes}
                          handleChange={handleCorreo}
                        //   borderErr={touchCorreo && formData.Correo == ""}
                        //   msjErr={"El correo es obligatorio."}
                        />

                        <Input
                          placeholder="Contrase√±a"
                          type="password"
                          iconoIzq={inconoPass}
                          iconoDer={inconoPassDer}
                          handleChange={handleContrase√±a}
                        //   borderErr={touchconfirmarContrase√±a && formData.confirmarContrase√±a !== formData.Contrase√±a}
                        //   msjErr={ "Las contrase√±as no coinciden."}
                        />
                    </div>
                     
                     <a
                      // href=""
                      className={styles.a}
                      onClick={recuperarPass}
                      style={{cursor:"pointer"}}

                      >Olvid√© mi contrase√±a</a>

                    <h1 className={styles.title} style={{marginTop:"40px"}}>
                        <img 
                          src={botonLog} 
                          alt="iniImg" 
                          className={styles.titleImg2} 
                    
                          onClick={isFormValid() ? handleSubmit : null}
                          style={{
                            filter: isFormValid() ? "none" : "grayscale(100%)",
                            opacity: isFormValid() ? 1 : 0.5,
                            pointerEvents: isFormValid() ? "auto" : "none",
                            cursor: isFormValid() ? "pointer" : "not-allowed",
                          }}
                          />
                    </h1>

                    <p 
                      className={styles.p}> 
                       Si no tienes un cuenta, 
                        <Link
                            to="/Registro"
                            className={styles.a}
                            onClick={recuperarPass}
                            >reg√≠strate aqu√≠</Link>
                   </p>
                </form>


                <div >
                    <h1 className={styles.title} style={{marginTop:"40px"}}>
                        <img
                            src={productosImg}
                            className={styles.productosImg}
                            />                 
                    </h1>
                </div>
            </div>
            <div className={styles.containerFooter}>
                <Footer></Footer>     
            </div>  
             
             
             <img src={ballonder2} alt="ballonder2" className={styles.ballonder2} />
             <img src={ballonder} alt="ballonder3" className={styles.ballonder} />
             <img src={ballon1zq} alt="ballon1zq" className={styles.ballon1zq} />
      </div>
    )
}


export default InicioSesion